# ABACUS 工作流配置文件
# 自动提交系统配置示例

# ============================================================================
# 环境配置
# ============================================================================
[ENV]
# Conda 安装路径
CONDA_PATH = /XYFS01/nscc-gz_pinchen_1/sf_install/miniconda3

# Conda 环境名称
CONDA_ENV = dftflow

# ============================================================================
# ABACUS 配置
# ============================================================================
[ABACUS]
# ABACUS 可执行文件目录
ABACUS_DIR = /XYFS01/nscc-gz_pinchen_1/sf_box/abacus-develop-LTSv3.10.0/bin

# ABACUS 可执行文件名
ABACUS_EXE = abacus

# 赝势文件目录
PSEUDO_POTENTIAL_DIR = /XYFS01/nscc-gz_pinchen_1/sf_box/abacus-develop-LTSv3.10.0/PotSG15

# 轨道基组文件目录
ORBITAL_DIR = /XYFS01/nscc-gz_pinchen_1/sf_box/abacus-develop-LTSv3.10.0/OrbSG15std

# ============================================================================
# 结构文件配置
# ============================================================================
[STRU]
# 结构文件路径（留空表示从命令行参数获取）
PATH = 

# 结构文件后缀匹配模式
SUFFIX = *.poscar

# ============================================================================
# 模块加载配置
# ============================================================================
[MODULE]
# 需要加载的环境模块（空格分隔）
MODULES = intel/oneapi2023.2_noimpi mpi/mpich/4.1.2-icc-oneapi2023.2-ch4 elpa/2024.05.001-icc-oneapi2023.2-mpich-4.1.2-ch4

# ============================================================================
# Slurm 自动提交配置
# ============================================================================
[ALLOW]
# ----------------------------------------------------------------------------
# 基本配置
# ----------------------------------------------------------------------------

# Slurm 分区名称
# 说明: 提交作业时使用的分区，必须与集群配置匹配
PARTITION = deimos

# 默认节点数
# 说明: 当脚本中未指定节点数时使用的默认值
NODES = 1

# 每节点核心数
# 说明: 用于计算核时消耗
CORES_PER_NODE = 64

# ----------------------------------------------------------------------------
# 资源限制配置（重要！）
# ----------------------------------------------------------------------------

# 总节点数限制（最重要的参数）
# 说明: 
#   - 系统会确保所有提交的作业使用的总节点数不超过此值
#   - 这是避免占用过多集群资源的关键参数
#   - 建议根据集群规模和用户权限设置
# 推荐值:
#   - 小规模测试: 5-10
#   - 中等规模: 20-50
#   - 大规模生产: 50-100
TOTAL_NODE = 10

# 最大任务数限制
# 说明:
#   - 队列中允许的最大任务数（包括运行中和等待中）
#   - 避免队列过长影响调度器性能
#   - 建议根据集群策略和用户限制设置
# 推荐值:
#   - 小规模: 100-500
#   - 中等规模: 500-2000
#   - 大规模: 2000-10000
MAX_JOBS = 1000

# ----------------------------------------------------------------------------
# 提交控制配置
# ----------------------------------------------------------------------------

# 提交间隔时间（秒）
# 说明:
#   - 每提交一个作业后等待的时间
#   - 避免短时间内大量提交对调度器造成压力
#   - 值越大越安全，但提交速度越慢
# 推荐值:
#   - 快速测试: 0.1-0.3
#   - 正常使用: 0.5-1.0
#   - 保守策略: 1.0-2.0
# 注意: 如果调度器响应慢或报错，应增大此值
INTERVAL_TIME = 0.5

# 队列检查时间（秒）
# 说明:
#   - 定期检查队列状态的时间间隔
#   - 用于监控资源使用情况
#   - 值越小响应越快，但 squeue 调用越频繁
# 推荐值:
#   - 快速响应: 30-60
#   - 正常使用: 60-120
#   - 减少开销: 120-300
CHECK_TIME = 80

# 配置重载检查间隔（秒）⭐ 新功能
# 说明:
#   - 定期检查配置文件是否有更新的时间间隔
#   - 如果配置文件被修改，系统会自动重新加载新配置
#   - 支持运行时动态调整资源限制，无需重启程序
# 推荐值:
#   - 快速响应: 300 (5分钟)
#   - 正常使用: 600 (10分钟)
#   - 减少检查: 1800 (30分钟)
# 使用场景:
#   - 你的quota随时间变化
#   - 需要根据集群负载动态调整
#   - 不想停止正在运行的提交任务
CONFIG_RELOAD_INTERVAL = 600

# ============================================================================
# 配置场景示例
# ============================================================================

# 场景1: 小规模测试（10-100个作业）
# ──────────────────────────────────────────
# TOTAL_NODE = 5
# MAX_JOBS = 100
# INTERVAL_TIME = 0.5
# CHECK_TIME = 60
# 说明: 适合快速测试，资源占用少，响应快

# 场景2: 中等规模生产（100-1000个作业）
# ──────────────────────────────────────────
# TOTAL_NODE = 20
# MAX_JOBS = 1000
# INTERVAL_TIME = 0.5
# CHECK_TIME = 80
# 说明: 平衡效率和负载，适合日常使用

# 场景3: 大规模生产（1000-100000个作业）
# ──────────────────────────────────────────
# TOTAL_NODE = 50
# MAX_JOBS = 5000
# INTERVAL_TIME = 1.0
# CHECK_TIME = 120
# 说明: 适合大规模计算，需要更长时间但更稳定

# 场景4: 资源受限（节点少/用户限制严格）
# ──────────────────────────────────────────
# TOTAL_NODE = 2
# MAX_JOBS = 10
# INTERVAL_TIME = 2.0
# CHECK_TIME = 30
# 说明: 资源紧张时使用，频繁检查快速利用空闲资源

# 场景5: 调度器压力大
# ──────────────────────────────────────────
# TOTAL_NODE = 10
# MAX_JOBS = 500
# INTERVAL_TIME = 2.0
# CHECK_TIME = 120
# 说明: 调度器负载高或响应慢时，降低提交频率

# ============================================================================
# 使用说明
# ============================================================================

# 1. 复制此文件为 condor.ini:
#    cp condor.ini.example condor.ini

# 2. 根据实际情况修改配置:
#    - 环境路径
#    - ABACUS 路径
#    - Slurm 分区名称
#    - 资源限制参数

# 3. 测试配置:
#    python test_submit.py

# 4. 使用自动提交:
#    python submit_jobs.py work_cal7

# 5. 监控提交进度:
#    tail -f logs/submit_*.log

# ============================================================================
# 故障排查
# ============================================================================

# 问题1: 提交速度太慢
# 解决: 减小 INTERVAL_TIME，增加 TOTAL_NODE 和 MAX_JOBS

# 问题2: 调度器报错或卡死
# 解决: 增加 INTERVAL_TIME，减小 MAX_JOBS

# 问题3: 资源一直显示不足
# 解决: 检查 TOTAL_NODE 是否设置过小，使用 squeue 和 sinfo 查看实际资源

# 问题4: 作业提交失败
# 解决: 检查 PARTITION 是否正确，检查用户权限

# ============================================================================
# 更多信息
# ============================================================================

# 详细文档: doc/auto_submit.md
# 快速开始: QUICK_START_SUBMIT.md
# 设计方案: DESIGN_SUMMARY.md
# 流程图: doc/workflow_diagram.md

